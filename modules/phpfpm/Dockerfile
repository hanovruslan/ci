ARG PHPFPMBASE_PHP_VERSION

FROM phpfpmbase_phpfpmbase:${PHPFPMBASE_PHP_VERSION}

ARG _CI_IMAGE_CI_DIR
ARG _CI_IMAGE_LOCAL_BIN_DIR
ARG _CI_IMAGE_WORK_DIR
ARG _CI_IMAGE_APP_DIR
ARG PHPFPM_PACKAGE_APT
ARG PHPFPM_PACKAGE_PHP_ENABLE
ARG PHPFPM_PACKAGE_PHP_INSTALL
ARG PHPFPM_PACKAGE_PECL

ENV _CI_IMAGE_CI_DIR=${_CI_IMAGE_CI_DIR}
ENV _CI_IMAGE_LOCAL_BIN_DIR=${_CI_IMAGE_LOCAL_BIN_DIR}
ENV _CI_IMAGE_WORK_DIR=${_CI_IMAGE_WORK_DIR}
ENV _CI_IMAGE_APP_DIR=${_CI_IMAGE_APP_DIR}
ENV PHPFPM_PACKAGE_PHP_ENABLE=${PHPFPM_PACKAGE_PHP_ENABLE}
ENV PHPFPM_PACKAGE_PHP_INSTALL=${PHPFPM_PACKAGE_PHP_INSTALL}
ENV PHPFPM_PACKAGE_PECL=${PHPFPM_PACKAGE_PECL}

COPY resources /

ONBUILD ARG _CI_RUNTIME_GID
ONBUILD ARG _CI_RUNTIME_HOME
ONBUILD ARG _CI_RUNTIME_UID
ONBUILD ARG _CI_RUNTIME_USER
ONBUILD ARG XDEBUG_CONFIG
ONBUILD ARG XDEBUG_SESSION

ONBUILD ENV _CI_RUNTIME_GID=${_CI_RUNTIME_GID}
ONBUILD ENV _CI_RUNTIME_HOME=${_CI_RUNTIME_HOME}
ONBUILD ENV _CI_RUNTIME_UID=${_CI_RUNTIME_UID}
ONBUILD ENV _CI_RUNTIME_USER=${_CI_RUNTIME_USER}
ONBUILD ENV XDEBUG_CONFIG=${XDEBUG_CONFIG}
ONBUILD ENV XDEBUG_SESSION=${XDEBUG_SESSION}

ONBUILD RUN bash -x "${_CI_IMAGE_CI_DIR}/container-batch.sh"

ONBUILD WORKDIR ${_CI_IMAGE_WORK_DIR}

ONBUILD USER ${_CI_RUNTIME_UID}:${_CI_RUNTIME_GID}
