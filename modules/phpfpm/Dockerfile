ARG BASE_PHP_VERSION
ARG _CI_USERFILES_VERSION
ARG DOCKER_REGISTRY_PATH
ARG GITLAB_HOST
ARG GITLAB_PORT
ARG INSTANTCLIENT_VERSION

FROM ${GITLAB_HOST}:${GITLAB_PORT}/ci/instantclient:${INSTANTCLIENT_VERSION} AS preparedInstantclient
FROM ${GITLAB_HOST}:${GITLAB_PORT}/ci/userfiles:${_CI_USERFILES_VERSION} AS preparedUserfiles
FROM ${DOCKER_REGISTRY_PATH}php:${BASE_PHP_VERSION}-fpm-buster

ARG _CI_IMAGE_CI_DIR
ARG _CI_IMAGE_LOCAL_BIN_DIR
ARG _CI_IMAGE_WORK_DIR
ARG _CI_IMAGE_APP_DIR
ARG _CI_PHP_VERSION
ARG INSTANTCLIENT_PATH
ARG PHPFPM_PACKAGE_APT
ARG PHPFPM_PACKAGE_PHP_ENABLE
ARG PHPFPM_PACKAGE_PHP_INSTALL

ENV _CI_IMAGE_CI_DIR=${_CI_IMAGE_CI_DIR}
ENV _CI_IMAGE_LOCAL_BIN_DIR=${_CI_IMAGE_LOCAL_BIN_DIR}
ENV _CI_IMAGE_WORK_DIR=${_CI_IMAGE_WORK_DIR}
ENV _CI_IMAGE_APP_DIR=${_CI_IMAGE_APP_DIR}
ENV LD_LIBRARY_PATH=${INSTANTCLIENT_PATH};LD_LIBRARY_PATH
ENV PHPFPM_PACKAGE_APT=${PHPFPM_PACKAGE_APT}
ENV PHPFPM_PACKAGE_PHP_ENABLE=${PHPFPM_PACKAGE_PHP_ENABLE}
ENV PHPFPM_PACKAGE_PHP_INSTALL=${PHPFPM_PACKAGE_PHP_INSTALL}

COPY resources /
COPY ${_CI_PHP_VERSION}.resources/ /
COPY --from=preparedInstantclient ${INSTANTCLIENT_PATH} ${INSTANTCLIENT_PATH}
COPY --from=preparedUserfiles ${_CI_IMAGE_CI_DIR}/user ${_CI_IMAGE_CI_DIR}/user

RUN bash -x "${_CI_IMAGE_CI_DIR}/image-batch.sh"

ONBUILD ARG _CI_RUNTIME_GID
ONBUILD ARG _CI_RUNTIME_HOME
ONBUILD ARG _CI_RUNTIME_UID
ONBUILD ARG _CI_RUNTIME_USER
ONBUILD ARG XDEBUG_CONFIG
ONBUILD ARG XDEBUG_SESSION

ONBUILD ENV _CI_RUNTIME_GID=${_CI_RUNTIME_GID}
ONBUILD ENV _CI_RUNTIME_HOME=${_CI_RUNTIME_HOME}
ONBUILD ENV _CI_RUNTIME_UID=${_CI_RUNTIME_UID}
ONBUILD ENV _CI_RUNTIME_USER=${_CI_RUNTIME_USER}
ONBUILD ENV XDEBUG_CONFIG=${XDEBUG_CONFIG}
ONBUILD ENV XDEBUG_SESSION=${XDEBUG_SESSION}

ONBUILD RUN bash -x "${_CI_IMAGE_CI_DIR}/container-batch.sh"

ONBUILD WORKDIR ${_CI_IMAGE_WORK_DIR}

ONBUILD USER ${_CI_RUNTIME_UID}:${_CI_RUNTIME_GID}
