ARG _CI_PUBLIC_NODE_VERSION
ARG _CI_USERFILES_VERSION

FROM userfiles_userfiles:${_CI_USERFILES_VERSION} AS preparedUserfiles
FROM node:${_CI_PUBLIC_NODE_VERSION}-buster

ARG _CI_IMAGE_ARTIFACT_DIR
ARG _CI_IMAGE_CI_DIR
ARG _CI_IMAGE_WORK_DIR
ARG _CI_IMAGE_APP_DIR
ARG _CI_NPM_REGISTRY

ENV _CI_IMAGE_ARTIFACT_DIR=${_CI_IMAGE_ARTIFACT_DIR}
ENV _CI_IMAGE_CI_DIR=${_CI_IMAGE_CI_DIR}
ENV _CI_IMAGE_WORK_DIR=${_CI_IMAGE_WORK_DIR}
ENV _CI_IMAGE_APP_DIR=${_CI_IMAGE_APP_DIR}
ENV _CI_NPM_REGISTRY=${_CI_NPM_REGISTRY}

COPY resources/ /
COPY --from=preparedUserfiles ${_CI_IMAGE_CI_DIR}/user ${_CI_IMAGE_CI_DIR}/user

RUN bash -x "${_CI_IMAGE_CI_DIR}/image-batch.sh"

ONBUILD ARG _CI_RUNTIME_GID
ONBUILD ARG _CI_RUNTIME_HOME
ONBUILD ARG _CI_RUNTIME_UID
ONBUILD ARG _CI_RUNTIME_USER

ONBUILD ENV _CI_RUNTIME_GID=${_CI_RUNTIME_GID}
ONBUILD ENV _CI_RUNTIME_HOME=${_CI_RUNTIME_HOME}
ONBUILD ENV _CI_RUNTIME_UID=${_CI_RUNTIME_UID}
ONBUILD ENV _CI_RUNTIME_USER=${_CI_RUNTIME_USER}

ONBUILD COPY id_rsa* /

ONBUILD RUN bash -x "${_CI_IMAGE_CI_DIR}/container-batch.sh"

ONBUILD WORKDIR ${_CI_IMAGE_APP_DIR}

ONBUILD VOLUME ${_CI_IMAGE_ARTIFACT_DIR}

ONBUILD USER ${_CI_RUNTIME_UID}:${_CI_RUNTIME_GID}

ENTRYPOINT ["bash"]
