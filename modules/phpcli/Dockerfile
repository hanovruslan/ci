ARG PHPCLIBASE_PHP_VERSION
ARG COMPOSER_VERSION

FROM composer:${COMPOSER_VERSION} AS preparedComposer
FROM phpclibase_phpclibase:${PHPCLIBASE_PHP_VERSION}

ARG _CI_IMAGE_ARTIFACT_DIR
ARG _CI_IMAGE_CI_DIR
ARG _CI_IMAGE_LOCAL_BIN_DIR
ARG _CI_IMAGE_WORK_DIR
ARG _CI_IMAGE_APP_DIR
ARG PHPCLI_PACKAGE_APT
ARG PHPCLI_PACKAGE_PECL
ARG PHPCLI_PACKAGE_PHP_INSTALL

ENV _CI_IMAGE_ARTIFACT_DIR=${_CI_IMAGE_ARTIFACT_DIR}
ENV _CI_IMAGE_CI_DIR=${_CI_IMAGE_CI_DIR}
ENV _CI_IMAGE_LOCAL_BIN_DIR=${_CI_IMAGE_LOCAL_BIN_DIR}
ENV _CI_IMAGE_WORK_DIR=${_CI_IMAGE_WORK_DIR}
ENV _CI_IMAGE_APP_DIR=${_CI_IMAGE_APP_DIR}
ENV PHPCLI_PACKAGE_APT=${PHPCLI_PACKAGE_APT}
ENV PHPCLI_PACKAGE_PECL=${PHPCLI_PACKAGE_PECL}
ENV PHPCLI_PACKAGE_PHP_INSTALL=${PHPCLI_PACKAGE_PHP_INSTALL}

COPY resources/ /
COPY --from=preparedComposer /usr/bin/composer ${_CI_IMAGE_LOCAL_BIN_DIR}/composer

RUN bash -x "${_CI_IMAGE_CI_DIR}/image-batch.sh"

ONBUILD ARG _CI_RUNTIME_COMPOSER_CACHE_DIR
ONBUILD ARG _CI_RUNTIME_COMPOSER_HOME
ONBUILD ARG _CI_RUNTIME_GID
ONBUILD ARG _CI_RUNTIME_HOME
ONBUILD ARG _CI_RUNTIME_SSH_USER
ONBUILD ARG _CI_RUNTIME_UID
ONBUILD ARG _CI_RUNTIME_USER

ONBUILD ENV _CI_RUNTIME_GID=${_CI_RUNTIME_GID}
ONBUILD ENV _CI_RUNTIME_HOME=${_CI_RUNTIME_HOME}
ONBUILD ENV _CI_RUNTIME_SSH_USER=${_CI_RUNTIME_SSH_USER}
ONBUILD ENV _CI_RUNTIME_UID=${_CI_RUNTIME_UID}
ONBUILD ENV _CI_RUNTIME_USER=${_CI_RUNTIME_USER}
ONBUILD ENV COMPOSER_CACHE_DIR=${_CI_RUNTIME_COMPOSER_CACHE_DIR:-}
ONBUILD ENV COMPOSER_HOME=${_CI_RUNTIME_COMPOSER_HOME:-}

ONBUILD RUN bash -x "${_CI_IMAGE_CI_DIR}/container-batch.sh"

ONBUILD WORKDIR ${_CI_IMAGE_APP_DIR}

ONBUILD VOLUME ${_CI_IMAGE_ARTIFACT_DIR}

ONBUILD USER ${_CI_RUNTIME_UID}:${_CI_RUNTIME_GID}

ENTRYPOINT ["entrypoint.sh"]
