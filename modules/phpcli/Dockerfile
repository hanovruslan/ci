ARG BASE_PHP_VERSION
ARG COMPOSER_VERSION
ARG DEPLOYER_VERSION
ARG _CI_USERFILES_VERSION
ARG DOCKER_REGISTRY_PATH
ARG GITLAB_HOST
ARG GITLAB_PORT
ARG HUMBUGBOX_VERSION
ARG INSTANTCLIENT_VERSION

FROM ${GITLAB_HOST}:${GITLAB_PORT}/docker/ci/humbugbox:${HUMBUGBOX_VERSION} AS preparedHumbugbox
FROM ${GITLAB_HOST}:${GITLAB_PORT}/docker/ci/instantclient:${INSTANTCLIENT_VERSION} AS preparedInstantclient
FROM ${GITLAB_HOST}:${GITLAB_PORT}/docker/ci/userfiles:${_CI_USERFILES_VERSION} AS preparedUserfiles
FROM ${GITLAB_HOST}:${GITLAB_PORT}/docker/composer/deployer:${DEPLOYER_VERSION} AS preparedDeployer
FROM ${DOCKER_REGISTRY_PATH}composer:${COMPOSER_VERSION} AS preparedComposer
FROM ${DOCKER_REGISTRY_PATH}php:${BASE_PHP_VERSION}-cli-buster

ARG _CI_IMAGE_ARTIFACT_DIR
ARG _CI_IMAGE_CI_DIR
ARG _CI_IMAGE_LOCAL_BIN_DIR
ARG _CI_IMAGE_WORK_DIR
ARG _CI_IMAGE_APP_DIR
ARG _CI_PHP_VERSION
ARG INSTANTCLIENT_PATH
ARG PHPCLI_PACKAGE_APT
ARG PHPCLI_PACKAGE_PHP_ENABLE
ARG PHPCLI_PACKAGE_PHP_INSTALL

ENV _CI_IMAGE_ARTIFACT_DIR=${_CI_IMAGE_ARTIFACT_DIR}
ENV _CI_IMAGE_CI_DIR=${_CI_IMAGE_CI_DIR}
ENV _CI_IMAGE_LOCAL_BIN_DIR=${_CI_IMAGE_LOCAL_BIN_DIR}
ENV _CI_IMAGE_WORK_DIR=${_CI_IMAGE_WORK_DIR}
ENV _CI_IMAGE_APP_DIR=${_CI_IMAGE_APP_DIR}
ENV INSTANTCLIENT_PATH=${INSTANTCLIENT_PATH}
ENV LD_LIBRARY_PATH=${INSTANTCLIENT_PATH};LD_LIBRARY_PATH
ENV PHPCLI_PACKAGE_APT=${PHPCLI_PACKAGE_APT}
ENV PHPCLI_PACKAGE_PHP_ENABLE=${PHPCLI_PACKAGE_PHP_ENABLE}
ENV PHPCLI_PACKAGE_PHP_INSTALL=${PHPCLI_PACKAGE_PHP_INSTALL}

COPY resources/ /
COPY ${_CI_PHP_VERSION}.resources/ /
COPY --from=preparedComposer /usr/bin/composer ${_CI_IMAGE_LOCAL_BIN_DIR}/composer
COPY --from=preparedUserfiles ${_CI_IMAGE_CI_DIR}/user ${_CI_IMAGE_CI_DIR}/user
COPY --from=preparedDeployer ${_CI_IMAGE_LOCAL_BIN_DIR}/deployer ${_CI_IMAGE_LOCAL_BIN_DIR}/deployer
COPY --from=preparedHumbugbox ${_CI_IMAGE_LOCAL_BIN_DIR}/humbugbox ${_CI_IMAGE_LOCAL_BIN_DIR}/humbugbox
COPY --from=preparedInstantclient ${INSTANTCLIENT_PATH} ${INSTANTCLIENT_PATH}

RUN bash -x "${_CI_IMAGE_CI_DIR}/image-batch.sh"

ONBUILD ARG _CI_RUNTIME_COMPOSER_CACHE_DIR
ONBUILD ARG _CI_RUNTIME_COMPOSER_HOME
ONBUILD ARG _CI_RUNTIME_GID
ONBUILD ARG _CI_RUNTIME_HOME
ONBUILD ARG _CI_RUNTIME_SATIS_HOST
ONBUILD ARG _CI_RUNTIME_SATIS_PASSWORD
ONBUILD ARG _CI_RUNTIME_SATIS_USER
ONBUILD ARG _CI_RUNTIME_SSH_USER
ONBUILD ARG _CI_RUNTIME_UID
ONBUILD ARG _CI_RUNTIME_USER

ONBUILD ENV _CI_RUNTIME_GID=${_CI_RUNTIME_GID}
ONBUILD ENV _CI_RUNTIME_HOME=${_CI_RUNTIME_HOME}
ONBUILD ENV _CI_RUNTIME_SATIS_HOST=${_CI_RUNTIME_SATIS_HOST}
ONBUILD ENV _CI_RUNTIME_SATIS_PASSWORD=${_CI_RUNTIME_SATIS_PASSWORD}
ONBUILD ENV _CI_RUNTIME_SATIS_USER=${_CI_RUNTIME_SATIS_USER}
ONBUILD ENV _CI_RUNTIME_SSH_USER=${_CI_RUNTIME_SSH_USER}
ONBUILD ENV _CI_RUNTIME_UID=${_CI_RUNTIME_UID}
ONBUILD ENV _CI_RUNTIME_USER=${_CI_RUNTIME_USER}
ONBUILD ENV COMPOSER_CACHE_DIR=${_CI_RUNTIME_COMPOSER_CACHE_DIR:-}
ONBUILD ENV COMPOSER_HOME=${_CI_RUNTIME_COMPOSER_HOME:-}

ONBUILD COPY id_rsa* /

ONBUILD RUN bash -x "${_CI_IMAGE_CI_DIR}/container-batch.sh"

ONBUILD WORKDIR ${_CI_IMAGE_APP_DIR}

ONBUILD VOLUME ${_CI_IMAGE_ARTIFACT_DIR}

ONBUILD USER ${_CI_RUNTIME_UID}:${_CI_RUNTIME_GID}

ENTRYPOINT ["entrypoint.sh"]
